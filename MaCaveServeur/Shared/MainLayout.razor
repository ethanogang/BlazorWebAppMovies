@inherits LayoutComponentBase
@implements IDisposable
@inject MaCaveServeur.Services.AppState State

<div class="app-shell">
    <div class="app-frame">

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-inner">
                <div>
                    <div class="brand">Ma Cave</div>
                    <div class="brand-sub">Gestion multi-sites</div>
                </div>

                <div class="sidebar-divider"></div>

                <div class="sidebar-links">
                    <NavMenu />
                </div>

                <div class="sidebar-divider"></div>

                <div class="sidebar-account">
                    <div class="account-card">
                        <div class="account-avatar">EA</div>
                        <div>
                            <div class="account-name">Ethan</div>
                            <div class="account-role">Admin</div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <main class="app-main">
            <div class="app-content">

                <div class="topbar hidden md:flex items-center justify-between mb-6">
                    <div>
                        <div class="topbar-label">Etablissement</div>
                        <select class="select topbar-select" @bind="SelectedSiteCode" @bind:after="OnSiteChanged">
                            @foreach (var s in State.AllSites)
                            {
                                <option value="@s.Code">@s.Label</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Topbar (mobile) -->
                <div class="md:hidden glass-panel p-3 mb-4 app-topbar">
                    <div class="flex items-center justify-between">
                        <div class="font-bold">Ma Cave</div>
                        <a class="btn-secondary" href="/cellar">Cave</a>
                    </div>
                    <div class="mt-3">
                        <label class="label">Restaurant</label>
                        <select class="select mt-2" @bind="SelectedSiteCode" @bind:after="OnSiteChanged">
                            @foreach (var s in State.AllSites)
                            {
                                <option value="@s.Code">@s.Label</option>
                            }
                        </select>
                    </div>
                </div>

                @Body
            </div>
        </main>
    </div>
</div>

@code {
    private string SelectedSiteCode = "ALL";

    protected override void OnInitialized()
    {
        SelectedSiteCode = State.CurrentSiteCode;
        State.Changed += OnStateChanged;
    }

    private void OnSiteChanged()
    {
        State.SetSite(SelectedSiteCode);
    }

    private void OnStateChanged()
    {
        SelectedSiteCode = State.CurrentSiteCode;
        _ = InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        State.Changed -= OnStateChanged;
    }
}
