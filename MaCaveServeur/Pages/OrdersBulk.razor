@page "/orders/bulk"
@using MaCaveServeur.Services
@inject OrderService OrderSvc
@inject IJSRuntime JS

<div class="page-header">
  <div class="page-eyebrow">Gestion</div>
  <div class="page-title">Commandes groupees par fournisseur</div>
  <div class="page-sub">Genere un classeur Excel par fournisseur ou un ZIP global.</div>
</div>

<div class="kpi-grid mt-8">
  <div class="kpi-card">
    <div class="kpi-label">Fournisseurs</div>
    <div class="kpi-value">@TotalSuppliers</div>
    <div class="kpi-meta">concernes</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Lignes</div>
    <div class="kpi-value">@TotalLines</div>
    <div class="kpi-meta">a exporter</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">ZIP</div>
    <div class="kpi-value">1</div>
    <div class="kpi-meta">global</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Excel</div>
    <div class="kpi-value">@TotalSuppliers</div>
    <div class="kpi-meta">fichiers</div>
  </div>
</div>

<div class="panel mt-6">
  <div class="card__title">Composer le bon de commande</div>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
    <div>
      <label class="label">Date de livraison</label>
      <input class="input" type="date" @bind="DeliveryDate" />
    </div>
    <div>
      <label class="label">Adresse de livraison</label>
      <input class="input" @bind="DeliveryAddress" />
    </div>
    <div class="md:col-span-2">
      <label class="label">Note d'introduction</label>
      <textarea class="textarea" rows="3" @bind="IntroNote"></textarea>
    </div>
    <div class="md:col-span-2">
      <label class="label">Note de fin</label>
      <input class="input" @bind="FooterNote" />
    </div>
    <div>
      <label class="label">Signature - Nom</label>
      <input class="input" @bind="SignatureName" />
    </div>
    <div>
      <label class="label">Signature - Fonction</label>
      <input class="input" @bind="SignatureRole" />
    </div>
    <div class="md:col-span-2">
      <label class="label">Signature - Etablissements</label>
      <input class="input" @bind="SignatureSites" />
    </div>
  </div>
</div>

@if (_rows == null)
{
  <div class="panel mt-6">Analyse des penuries...</div>
}
else if (_rows.Count == 0)
{
  <div class="panel mt-6">Aucune penurie detectee.</div>
}
else
{
  <div class="row mt-6">
    <div class="panel space-y-3">
      <div class="card__title">Export global</div>
      <button class="btn-primary" @onclick="DownloadAllZip">Telecharger tout (ZIP)</button>
    </div>

    <div class="panel space-y-3">
      <div class="card__title">Par fournisseur</div>
      @foreach (var g in _rows.GroupBy(r => r.Supplier).OrderBy(g => g.Key))
      {
        var email = BuildEmail(g.ToList());
        <div class="flex items-center justify-between gap-3 rounded-xl border border-white/10 bg-white/5 px-4 py-3">
          <div>
            <div class="font-semibold text-black">@g.Key</div>
            <div class="text-black/60 text-sm">@g.Count() ligne(s)</div>
            @if (email.to.Count > 0)
            {
              <div class="text-black/60 text-xs mt-1">@string.Join("; ", email.to)</div>
            }
            else
            {
              <div class="text-black/60 text-xs mt-1">Email fournisseur manquant</div>
            }
          </div>
          <div class="flex items-center gap-2">
            @if (email.to.Count > 0)
            {
              <a class="btn-primary" href="@email.mailto">Ouvrir le mail</a>
            }
            <button class="btn-secondary" @onclick="() => DownloadOneSupplier(g.Key)">Telecharger Excel</button>
          </div>
        </div>
      }
    </div>
  </div>
}

@code {
  private List<OrderService.ShortageLine>? _rows;
  private int TotalSuppliers;
  private int TotalLines;
  private DateTime DeliveryDate = DateTime.Today;
  private string IntroNote = "Bonjour,";
  private string DeliveryAddress = "Brasserie Maillard, 17 rue Saint Rémy, 33000 Bordeaux";
  private string FooterNote = "Merci de bien facturer les bons établissements";
  private string SignatureName = "ETHAN FONTAINE";
  private string SignatureRole = "SOMMELIER // www.maison-amour.fr";
  private string SignatureSites = "Brutus, Brasserie Maillard, Gramma, Bacchus, Merlot, Banquet";

  protected override void OnInitialized()
  {
    _rows = OrderSvc.GetShortages();
    TotalLines = _rows?.Count ?? 0;
    TotalSuppliers = _rows?
      .Select(r => r.Supplier)
      .Where(s => !string.IsNullOrWhiteSpace(s))
      .Distinct(StringComparer.OrdinalIgnoreCase)
      .Count() ?? 0;
    DeliveryDate = NextWednesday(DateTime.Today);
  }

  private static DateTime NextWednesday(DateTime today)
  {
    var daysUntil = ((int)DayOfWeek.Wednesday - (int)today.DayOfWeek + 7) % 7;
    if (daysUntil == 0) daysUntil = 7;
    return today.AddDays(daysUntil);
  }

  private async Task DownloadAllZip()
  {
    var bytes = OrderSvc.BuildAllSuppliersZip();
    var b64 = Convert.ToBase64String(bytes);
    var file = $"Commandes_Groupees_{DateTime.Now:yyyyMMdd_HHmm}.zip";
    await JS.InvokeVoidAsync("saveFile", file, "application/zip", b64);
  }

  private async Task DownloadOneSupplier(string supplier)
  {
    var bytes = OrderSvc.BuildSupplierWorkbook(supplier);
    var b64 = Convert.ToBase64String(bytes);
    var file = $"Commande_{Sanitize(supplier)}_{DateTime.Now:yyyyMMdd_HHmm}.xlsx";
    await JS.InvokeVoidAsync("saveFile", file, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet", b64);
  }

  private (string mailto, List<string> to) BuildEmail(List<OrderService.ShortageLine> lines)
  {
    if (lines.Count == 0) return ("", new List<string>());
    var order = OrderSvc.BuildOrderFromShortages(lines);
    var options = new OrderService.EmailOptions
    {
      DeliveryDate = DeliveryDate,
      IntroNote = IntroNote,
      DeliveryAddress = DeliveryAddress,
      FooterNote = FooterNote,
      SignatureName = SignatureName,
      SignatureRole = SignatureRole,
      SignatureSites = SignatureSites
    };
    var email = OrderSvc.PrepareEmail(order, options);
    if (email.to.Count == 0) return ("", email.to);
    var to = string.Join(";", email.to);
    var subject = Uri.EscapeDataString(email.subject ?? string.Empty);
    var body = Uri.EscapeDataString(email.body ?? string.Empty);
    return ($"mailto:{to}?subject={subject}&body={body}", email.to);
  }

  private static string Sanitize(string v) =>
      string.Concat((v ?? "").Where(ch => char.IsLetterOrDigit(ch) || ch=='-' || ch=='_' || ch==' ')).Trim();
}
