@page "/suppliers"
@using MaCaveServeur.Models
@inject MaCaveServeur.Services.SupplierService SupplierSvc

<div class="page-header">
  <div class="page-eyebrow">Referentiel</div>
  <div class="page-title">Fournisseurs</div>
  <div class="page-sub">Gerer le referentiel fournisseurs.</div>
</div>

<div class="kpi-grid mt-8">
  <div class="kpi-card">
    <div class="kpi-label">Fournisseurs</div>
    <div class="kpi-value">@TotalSuppliers</div>
    <div class="kpi-meta">actifs</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Email</div>
    <div class="kpi-value">@WithEmail</div>
    <div class="kpi-meta">renseignes</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Telephone</div>
    <div class="kpi-value">@WithPhone</div>
    <div class="kpi-meta">renseignes</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">Contacts</div>
    <div class="kpi-value">@WithContact</div>
    <div class="kpi-meta">renseignes</div>
  </div>
</div>

<div class="panel mt-6">
  <div class="toolbar">
    <div class="toolbar-actions">
      <button class="btn-primary" @onclick="NewSupplier">Nouveau fournisseur</button>
      <button class="btn-secondary" @onclick="ExportExcel">Exporter Excel</button>
      <a class="btn-secondary" href="/suppliers/import">Importer Excel</a>
    </div>
    <div class="toolbar-actions">
      <input class="input max-w-xs" placeholder="Rechercher un fournisseur..." @bind="Search" @bind:event="oninput" />
    </div>
  </div>
</div>

@if (loading)
{
  <div class="panel mt-6">Chargement...</div>
}
else
{
  <div class="panel mt-6">
    <div class="table-wrap">
      <table class="table">
        <thead class="thead">
          <tr>
            <th>Nom</th>
            <th>Contact</th>
            <th>Email commande</th>
            <th>Telephone</th>
            <th>Notes</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          @foreach (var s in FilteredSuppliers)
          {
            <tr class="trow">
              <td>@s.Name</td>
              <td>@s.ContactName</td>
              <td>@s.OrderEmail</td>
              <td>@s.Phone</td>
              <td>@s.Notes</td>
              <td class="text-right">
                <div class="table-actions">
                  <button class="btn-secondary" @onclick="(() => Edit(s))">Editer</button>
                  <button class="btn-danger" @onclick="(() => Delete(s.Id))">Supprimer</button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
}

@if (editing is not null)
{
  <div class="panel mt-6">
    <div class="card__title">@((editing!.Id == Guid.Empty) ? "Nouveau fournisseur" : "Modifier le fournisseur")</div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <div>
        <label class="label">Nom</label>
        <input class="input" @bind="editing.Name" />
      </div>
      <div>
        <label class="label">Contact</label>
        <input class="input" @bind="editing.ContactName" />
      </div>
      <div>
        <label class="label">Email commande</label>
        <input class="input" @bind="editing.OrderEmail" type="email" />
      </div>
      <div>
        <label class="label">Telephone</label>
        <input class="input" @bind="editing.Phone" />
      </div>
      <div class="md:col-span-2">
        <label class="label">Notes</label>
        <input class="input" @bind="editing.Notes" />
      </div>
    </div>

    <div class="flex gap-3 mt-4">
      <button class="btn-primary" @onclick="Save">Enregistrer</button>
      <button class="btn-secondary" @onclick="Cancel">Annuler</button>
    </div>
  </div>
}

@code {
  bool loading = true;
  List<Supplier> suppliers = new();
  Supplier? editing;
  string Search = "";

  protected override async Task OnInitializedAsync()
  {
    await Reload();
  }

  async Task Reload()
  {
    loading = true;
    suppliers = await SupplierSvc.AllAsync();
    loading = false;
    StateHasChanged();
  }

  void NewSupplier()
  {
    editing = new Supplier { Id = Guid.Empty, Name = "" };
  }

  void Edit(Supplier s)
  {
    editing = new Supplier
    {
      Id = s.Id,
      Name = s.Name,
      ContactName = s.ContactName,
      OrderEmail = s.OrderEmail,
      Phone = s.Phone,
      Notes = s.Notes
    };
  }

  async Task Save()
  {
    if (editing is null) return;
    if (string.IsNullOrWhiteSpace(editing.Name))
      return;

    await SupplierSvc.UpsertAsync(editing);
    editing = null;
    await Reload();
  }

  void Cancel()
  {
    editing = null;
  }

  IEnumerable<Supplier> FilteredSuppliers
  {
    get
    {
      var q = suppliers.AsEnumerable();
      var s = (Search ?? "").Trim();
      if (!string.IsNullOrWhiteSpace(s))
        q = q.Where(x => (x.Name ?? "").Contains(s, StringComparison.OrdinalIgnoreCase));
      return q;
    }
  }

  int TotalSuppliers => suppliers.Count;
  int WithEmail => suppliers.Count(s => !string.IsNullOrWhiteSpace(s.OrderEmail));
  int WithPhone => suppliers.Count(s => !string.IsNullOrWhiteSpace(s.Phone));
  int WithContact => suppliers.Count(s => !string.IsNullOrWhiteSpace(s.ContactName));

  async Task Delete(Guid id)
  {
    await SupplierSvc.DeleteAsync(id);
    await Reload();
  }

  async Task ExportExcel()
  {
    var bytes = await SupplierSvc.ExportExcelAsync();
    var fileName = $"fournisseurs_{DateTime.Now:yyyyMMdd_HHmm}.xlsx";
    await using var stream = new MemoryStream(bytes);
    using var ms = new MemoryStream(bytes);
  }
}
