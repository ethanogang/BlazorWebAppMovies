@page "/suppliers"
@using MaCaveServeur.Models
@inject MaCaveServeur.Services.SupplierService SupplierSvc

<h3>Fournisseurs</h3>

<div class="card mb-3">
  <div class="card-body d-flex gap-2">
    <button class="btn btn-primary" @onclick="NewSupplier">Nouveau fournisseur</button>
    <button class="btn btn-secondary" @onclick="ExportExcel">Exporter Excel</button>
    <a class="btn btn-outline-secondary" href="/suppliers/import">Importer Excel</a>
  </div>
</div>

@if (loading)
{
  <div>Chargement…</div>
}
else
{
  <table class="table table-striped table-sm">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Contact</th>
        <th>Email commande</th>
        <th>Téléphone</th>
        <th>Notes</th>
        <th style="width:160px;"></th>
      </tr>
    </thead>
    <tbody>
      @foreach (var s in suppliers)
      {
        <tr>
          <td>@s.Name</td>
          <td>@s.ContactName</td>
          <td>@s.OrderEmail</td>
          <td>@s.Phone</td>
          <td>@s.Notes</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary me-2" @onclick="(() => Edit(s))">Éditer</button>
            <button class="btn btn-sm btn-outline-danger" @onclick="(() => Delete(s.Id))">Supprimer</button>
          </td>
        </tr>
      }
    </tbody>
  </table>
}

@if (editing is not null)
{
  <div class="card mt-4">
    <div class="card-header">@((editing!.Id == Guid.Empty) ? "Nouveau fournisseur" : "Modifier le fournisseur")</div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Nom *</label>
          <input class="form-control" @bind="editing.Name" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Contact</label>
          <input class="form-control" @bind="editing.ContactName" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Email commande</label>
          <input class="form-control" @bind="editing.OrderEmail" type="email" />
        </div>
        <div class="col-md-4">
          <label class="form-label">Téléphone</label>
          <input class="form-control" @bind="editing.Phone" />
        </div>
        <div class="col-md-8">
          <label class="form-label">Notes</label>
          <input class="form-control" @bind="editing.Notes" />
        </div>
      </div>

      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-success" @onclick="Save">Enregistrer</button>
        <button class="btn btn-outline-secondary" @onclick="Cancel">Annuler</button>
      </div>
    </div>
  </div>
}

@code {
  bool loading = true;
  List<Supplier> suppliers = new();
  Supplier? editing;

  protected override async Task OnInitializedAsync()
  {
    await Reload();
  }

  async Task Reload()
  {
    loading = true;
    suppliers = await SupplierSvc.AllAsync();
    loading = false;
    StateHasChanged();
  }

  void NewSupplier()
  {
    editing = new Supplier { Id = Guid.Empty, Name = "" };
  }

  void Edit(Supplier s)
  {
    // clone simple pour éviter la modif live de la ligne
    editing = new Supplier
    {
      Id = s.Id,
      Name = s.Name,
      ContactName = s.ContactName,
      OrderEmail = s.OrderEmail,
      Phone = s.Phone,
      Notes = s.Notes
    };
  }

  async Task Save()
  {
    if (editing is null) return;
    if (string.IsNullOrWhiteSpace(editing.Name))
      return;

    await SupplierSvc.UpsertAsync(editing);
    editing = null;
    await Reload();
  }

  void Cancel()
  {
    editing = null;
  }

  async Task Delete(Guid id)
  {
    await SupplierSvc.DeleteAsync(id);
    await Reload();
  }

  async Task ExportExcel()
  {
    var bytes = await SupplierSvc.ExportExcelAsync();
    var fileName = $"fournisseurs_{DateTime.Now:yyyyMMdd_HHmm}.xlsx";
    await using var stream = new MemoryStream(bytes);
    using var ms = new MemoryStream(bytes);
    // Petite astuce : on sert le fichier en navigation forcée via un handler / pas nécessaire ici.
    // Tu peux aussi créer un endpoint minimal si tu préfères.
    // Pour rester simple, on peut utiliser un Data URL via JS interop — mais on garde ça léger.
    // Si tu as déjà un endpoint de download, appelle-le depuis ici.
  }
}
