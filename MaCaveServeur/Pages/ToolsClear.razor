@page "/tools/clear"
@inject NavigationManager Nav

<h1>üß® Purge compl√®te de la cave</h1>
<p style="color:#b00">Action destructive : supprime toutes les bouteilles (tous √©tablissements).</p>

<div class="card" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
  <button class="btn danger" @onclick="Confirm">Supprimer TOUTES les bouteilles</button>
  @if (confirming)
  {
    <span>Confirmer ?</span>
    <button class="btn" @onclick="DoClear">Oui, supprimer</button>
    <button class="btn ghost" @onclick="()=>confirming=false">Annuler</button>
  }
</div>

@if (!string.IsNullOrEmpty(msg))
{
  <p>@msg</p>
}

@code {
  bool confirming = false;
  string msg = "";

  void Confirm() => confirming = true;

  async Task DoClear()
  {
    try
    {
      using var http = new HttpClient { BaseAddress = new Uri(Nav.BaseUri) };
      var resp = await http.GetAsync("/api/cellar/clear?confirm=YES");
      if (resp.IsSuccessStatusCode)
      {
        msg = "‚úÖ Cave vid√©e.";
      }
      else
      {
        msg = "‚ùå " + await resp.Content.ReadAsStringAsync();
      }
    }
    catch (Exception ex)
    {
      msg = "‚ùå Erreur : " + ex.Message;
    }
    finally
    {
      confirming = false;
      StateHasChanged();
    }
  }
}
