@page "/tools/clear"
@inject NavigationManager Nav

<div class="page-header">
  <div class="page-eyebrow">Outils</div>
  <div class="page-title">Purge complete de la cave</div>
  <div class="page-sub text-red-300">Action destructive : supprime toutes les bouteilles (tous etablissements).</div>
</div>

<div class="panel mt-6 flex flex-wrap items-center gap-3">
  <button class="btn-danger" @onclick="Confirm">Supprimer TOUTES les bouteilles</button>
  @if (confirming)
  {
    <span class="text-white/70">Confirmer ?</span>
    <button class="btn-secondary" @onclick="DoClear">Oui, supprimer</button>
    <button class="btn-secondary" @onclick="()=>confirming=false">Annuler</button>
  }
</div>

@if (!string.IsNullOrEmpty(msg))
{
  <div class="panel mt-6">@msg</div>
}

@code {
  bool confirming = false;
  string msg = "";

  void Confirm() => confirming = true;

  async Task DoClear()
  {
    try
    {
      using var http = new HttpClient { BaseAddress = new Uri(Nav.BaseUri) };
      var resp = await http.GetAsync("/api/cellar/clear?confirm=YES");
      if (resp.IsSuccessStatusCode)
      {
        msg = "Cave videe.";
      }
      else
      {
        msg = "Erreur: " + await resp.Content.ReadAsStringAsync();
      }
    }
    catch (Exception ex)
    {
      msg = "Erreur : " + ex.Message;
    }
    finally
    {
      confirming = false;
      StateHasChanged();
    }
  }
}
