@page "/cellar/new"
@page "/cellar/new/{Id:guid}"

@using MaCaveServeur.Models
@using MaCaveServeur.Services
@using Microsoft.AspNetCore.Components.Forms

@inject CellarService CellarSvc
@inject AppState State
@inject NavigationManager Nav

<PageTitle>Ajouter / Éditer</PageTitle>

<div class="max-w-4xl mx-auto">

    <header class="glass-panel mb-6 p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white">@Title</h1>
                <p class="text-white/70">
                    Site : <span class="font-semibold">@State.CurrentSiteName</span>
                </p>
            </div>
            <div class="flex gap-3">
                <button class="btn-secondary" @onclick="Back">Retour</button>
                @if (IsEdit)
                {
                    <button class="btn-danger" @onclick="Delete">Supprimer</button>
                }
            </div>
        </div>
    </header>

    @if (!string.IsNullOrWhiteSpace(Alert))
    {
        <div class="glass-panel p-4 mb-6">
            <div class="text-white">@Alert</div>
        </div>
    }

    <EditForm Model="Bottle" OnValidSubmit="Save">
        <DataAnnotationsValidator />

        <div class="glass-panel p-6 space-y-5">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Établissement</label>
                    <InputSelect class="select" @bind-Value="Bottle.SiteCode">
                        @foreach (var s in State.AllSites.Where(s => s.Code != "ALL"))
                        {
                            <option value="@s.Code">@s.Label</option>
                        }
                    </InputSelect>
                </div>

                <div>
                    <label class="label">Couleur / Type</label>
                    <InputText class="input" @bind-Value="Bottle.Color" placeholder="RED-WINE / WHITE-WINE / ..." />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Producteur</label>
                    <InputText class="input" @bind-Value="Bottle.Producer" />
                </div>
                <div>
                    <label class="label">Nom</label>
                    <InputText class="input" @bind-Value="Bottle.Name" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Région</label>
                    <InputText class="input" @bind-Value="Bottle.Region" />
                </div>
                <div>
                    <label class="label">Appellation</label>
                    <InputText class="input" @bind-Value="Bottle.Appellation" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="label">Millésime</label>
                    <InputNumber class="input" @bind-Value="Bottle.Vintage" />
                </div>
                <div>
                    <label class="label">Quantité</label>
                    <InputNumber class="input" @bind-Value="Bottle.Quantity" />
                </div>
                <div>
                    <label class="label">Seuil alerte</label>
                    <InputNumber class="input" @bind-Value="Bottle.LowStockThreshold" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Fournisseur</label>
                    <InputText class="input" @bind-Value="Bottle.Supplier" />
                </div>
                <div>
                    <label class="label">Cépages</label>
                    <InputText class="input" @bind-Value="Bottle.Grapes" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Prix achat</label>
                    <InputNumber class="input" @bind-Value="Bottle.PurchasePrice" />
                </div>
                <div>
                    <label class="label">Prix vente</label>
                    <InputNumber class="input" @bind-Value="Bottle.SalePrice" />
                </div>
            </div>

            <div>
                <label class="label">Notes</label>
                <InputTextArea class="textarea" rows="4" @bind-Value="Bottle.Notes" />
            </div>

            <div class="flex gap-3 pt-2">
                <button type="submit" class="btn-primary">Enregistrer</button>
                <button type="button" class="btn-secondary" @onclick="Back">Annuler</button>
            </div>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public Guid? Id { get; set; }

    private Bottle Bottle { get; set; } = new Bottle();
    private string? Alert;

    private bool IsEdit => Id.HasValue && Id.Value != Guid.Empty;
    private string Title => IsEdit ? "✏️ Éditer une bouteille" : "➕ Ajouter une bouteille";

    protected override void OnInitialized()
    {
        if (!IsEdit)
        {
            Bottle.Id = Guid.NewGuid();
            Bottle.SiteCode = State.IsAll ? "BRUTUS" : State.CurrentSiteCode;
            Bottle.LowStockThreshold = 3;
            Bottle.Quantity = 0;
            Bottle.Vintage = 0;
            return;
        }

        var b = CellarSvc.GetWine(Id!.Value);
        if (b == null)
        {
            Alert = "Bouteille introuvable.";
            Bottle = new Bottle { Id = Id!.Value };
            return;
        }

        Bottle = b;

        if (string.IsNullOrWhiteSpace(Bottle.SiteCode))
            Bottle.SiteCode = State.IsAll ? "BRUTUS" : State.CurrentSiteCode;
    }

    private void Save()
    {
        Alert = null;

        Bottle.SiteCode = (Bottle.SiteCode ?? "").Trim().ToUpperInvariant();
        Bottle.Name = (Bottle.Name ?? "").Trim();
        Bottle.Producer = (Bottle.Producer ?? "").Trim();

        try
        {
            if (IsEdit)
                CellarSvc.UpdateWine(Bottle);
            else
                CellarSvc.AddWine(Bottle);

            Nav.NavigateTo("/cellar");
        }
        catch (Exception ex)
        {
            Alert = $"Erreur : {ex.Message}";
        }
    }

    private void Delete()
    {
        if (!IsEdit) return;

        try
        {
            CellarSvc.DeleteWine(Id!.Value);
            Nav.NavigateTo("/cellar");
        }
        catch (Exception ex)
        {
            Alert = $"Erreur suppression : {ex.Message}";
        }
    }

    private void Back() => Nav.NavigateTo("/cellar");
}
