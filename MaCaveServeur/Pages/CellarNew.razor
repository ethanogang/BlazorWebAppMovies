@page "/cellar/new"
@page "/cellar/new/{Id:guid}"

@using MaCaveServeur.Models
@using MaCaveServeur.Services
@using Microsoft.AspNetCore.Components.Forms

@inject CellarService CellarSvc
@inject AppState State
@inject NavigationManager Nav

<PageTitle>Ajouter / Editer</PageTitle>

<div class="max-w-4xl mx-auto">
    <div class="page-header">
        <div class="page-eyebrow">Bouteille</div>
        <div class="page-title">@Title</div>
        <div class="page-sub">Site : <span class="font-semibold text-white">@State.CurrentSiteName</span></div>
    </div>

    <div class="flex gap-3 mt-4">
        <button class="btn-secondary" @onclick="Back">Retour</button>
        @if (IsEdit)
        {
            <button class="btn-danger" @onclick="Delete">Supprimer</button>
        }
    </div>

    @if (!string.IsNullOrWhiteSpace(Alert))
    {
        <div class="panel mt-6">
            <div class="text-white">@Alert</div>
        </div>
    }

    <EditForm Model="Bottle" OnValidSubmit="Save">
        <DataAnnotationsValidator />

        <div class="panel mt-6 space-y-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Etablissement</label>
                    <InputSelect class="select" @bind-Value="Bottle.SiteCode">
                        @foreach (var s in State.AllSites.Where(s => s.Code != "ALL"))
                        {
                            <option value="@s.Code">@s.Label</option>
                        }
                    </InputSelect>
                </div>

                <div>
                    <label class="label">Couleur / Type</label>
                    <InputText class="input" @bind-Value="Bottle.Color" placeholder="RED-WINE / WHITE-WINE / ..." />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Code produit</label>
                    <InputText class="input" @bind-Value="Bottle.ProductReferenceCode" />
                </div>
                <div>
                    <label class="label">Designation</label>
                    <InputText class="input" @bind-Value="Bottle.Designation" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Producteur</label>
                    <InputText class="input" @bind-Value="Bottle.Producer" />
                </div>
                <div>
                    <label class="label">Nom</label>
                    <InputText class="input" @bind-Value="Bottle.Name" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Region</label>
                    <InputText class="input" @bind-Value="Bottle.Region" />
                </div>
                <div>
                    <label class="label">Appellation</label>
                    <InputText class="input" @bind-Value="Bottle.Appellation" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="label">Millesime</label>
                    <InputNumber class="input" @bind-Value="Bottle.Vintage" />
                </div>
                <div>
                    <label class="label">Contenance (ml)</label>
                    <InputNumber class="input" @bind-Value="Bottle.Capacity" />
                </div>
                <div>
                    <label class="label">Quantite</label>
                    <InputNumber class="input" @bind-Value="Bottle.Quantity" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Fournisseur</label>
                    <InputText class="input" @bind-Value="Bottle.Supplier" />
                </div>
                <div>
                    <label class="label">Cepages</label>
                    <InputText class="input" @bind-Value="Bottle.Grapes" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Prix achat</label>
                    <InputNumber class="input" @bind-Value="Bottle.PurchasePrice" />
                </div>
                <div>
                    <label class="label">Prix vente</label>
                    <InputNumber class="input" @bind-Value="Bottle.SalePrice" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Prix verre</label>
                    <InputNumber class="input" @bind-Value="Bottle.GlassSellPrice" />
                </div>
                <div>
                    <label class="label">Seuil alerte</label>
                    <InputNumber class="input" @bind-Value="Bottle.LowStockThreshold" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">ID externe</label>
                    <InputText class="input" @bind-Value="Bottle.ExternalId" />
                </div>
                <div>
                    <label class="label">ID verre</label>
                    <InputText class="input" @bind-Value="Bottle.GlassExternalId" />
                </div>
            </div>

            <div>
                <label class="label">Notes</label>
                <InputTextArea class="textarea" rows="4" @bind-Value="Bottle.Notes" />
            </div>

            <div class="flex gap-3 pt-2">
                <button type="submit" class="btn-primary">Enregistrer</button>
                <button type="button" class="btn-secondary" @onclick="Back">Annuler</button>
            </div>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public Guid? Id { get; set; }

    private Bottle Bottle { get; set; } = new Bottle();
    private string? Alert;

    private bool IsEdit => Id.HasValue && Id.Value != Guid.Empty;
    private string Title => IsEdit ? "Editer une bouteille" : "Ajouter une bouteille";

    protected override void OnInitialized()
    {
        if (!IsEdit)
        {
            Bottle.Id = Guid.NewGuid();
            Bottle.SiteCode = State.IsAll ? "BRUTUS" : State.CurrentSiteCode;
            Bottle.LowStockThreshold = 3;
            Bottle.Quantity = 0;
            Bottle.Vintage = 0;
            return;
        }

        var b = CellarSvc.GetWine(Id!.Value);
        if (b == null)
        {
            Alert = "Bouteille introuvable.";
            Bottle = new Bottle { Id = Id!.Value };
            return;
        }

        Bottle = b;

        if (string.IsNullOrWhiteSpace(Bottle.SiteCode))
            Bottle.SiteCode = State.IsAll ? "BRUTUS" : State.CurrentSiteCode;
    }

    private void Save()
    {
        Alert = null;

        Bottle.SiteCode = (Bottle.SiteCode ?? "").Trim().ToUpperInvariant();
        Bottle.Name = (Bottle.Name ?? "").Trim();
        Bottle.Producer = (Bottle.Producer ?? "").Trim();

        try
        {
            if (IsEdit)
                CellarSvc.UpdateWine(Bottle);
            else
                CellarSvc.AddWine(Bottle);

            Nav.NavigateTo("/cellar");
        }
        catch (Exception ex)
        {
            Alert = $"Erreur : {ex.Message}";
        }
    }

    private void Delete()
    {
        if (!IsEdit) return;

        try
        {
            CellarSvc.DeleteWine(Id!.Value);
            Nav.NavigateTo("/cellar");
        }
        catch (Exception ex)
        {
            Alert = $"Erreur suppression : {ex.Message}";
        }
    }

    private void Back() => Nav.NavigateTo("/cellar");
}
