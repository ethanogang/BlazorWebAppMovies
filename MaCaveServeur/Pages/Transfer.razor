@page "/transfer"
@page "/transfer/{Id:guid}"
@using MaCaveServeur.Models
@inject MaCaveServeur.Services.CellarService CellarSvc
@inject MaCaveServeur.Services.AppState State
@inject NavigationManager Nav

<h1>üîÅ Transfert entre √©tablissements</h1>

@if (!string.IsNullOrEmpty(alert))
{
  <div class="card" style="border-left:4px solid @(alertOk ? "#39b36b" : "#e65b62")">
    @alert
  </div>
}

<div class="card" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px; align-items:start">
  <div>
    <label>Source (bouteille)</label>
    <select @bind="sourceId" @bind:after="OnSourceChanged">
      <option value="">‚Äî Choisir ‚Äî</option>
      @foreach (var b in SourceList)
      {
        <option value="@b.Id.ToString()">@FormatBottle(b)</option>
      }
    </select>
  </div>

  <div>
    <label>√âtablissement cible</label>
    <select @bind="targetSite">
      <option value="">‚Äî Choisir ‚Äî</option>
      @foreach (var s in State.Sites)
      {
        <option value="@s">@s</option>
      }
    </select>
  </div>

  <div>
    <label>Quantit√© √† transf√©rer</label>
    <input type="number" min="1" @bind="qty" />
    <div style="color:var(--muted); font-size:.9rem; margin-top:4px">
      Dispo : @(selected?.Quantity ?? 0)
    </div>
  </div>

  <div>
    <label>Options</label>
    <div style="display:flex; gap:8px; align-items:center;">
      <input type="checkbox" id="optDel" @bind="deleteWhenZero" />
      <label for="optDel">Supprimer la r√©f√©rence source si stock = 0</label>
    </div>
  </div>
</div>

<div style="display:flex; gap:8px; margin-top:12px">
  <button class="btn primary" @onclick="DoTransfer" disabled="@Disabled">Transf√©rer</button>
  <button class="btn ghost" @onclick="Back">Retour</button>
</div>

@code {
  [Parameter] public Guid? Id { get; set; }

  string? alert;
  bool alertOk;

  string? sourceId;
  string? targetSite;
  int qty = 1;
  bool deleteWhenZero = false;

  Bottle? selected;

  IEnumerable<Bottle> SourceList => CellarSvc.Bottles
      .OrderBy(b => b.Location).ThenBy(b => b.Producer).ThenBy(b => b.Name);

  protected override void OnInitialized()
  {
    if (Id.HasValue)
    {
      selected = CellarSvc.Get(Id.Value);
      sourceId = selected?.Id.ToString();
    }
  }

  void OnSourceChanged()
  {
    selected = Guid.TryParse(sourceId, out var gid) ? CellarSvc.Get(gid) : null;
  }

  bool Disabled => selected == null
                   || string.IsNullOrWhiteSpace(targetSite)
                   || qty <= 0
                   || (selected?.Quantity ?? 0) <= 0;

  void DoTransfer()
  {
    alert = null; alertOk = false;

    if (selected == null) { alert = "Choisis une bouteille source."; return; }
    if (string.IsNullOrWhiteSpace(selected.Location)) { alert = "La bouteille n‚Äôa pas de site source."; return; }
    if (string.IsNullOrWhiteSpace(targetSite)) { alert = "Choisis un √©tablissement cible."; return; }
    if (string.Equals(selected.Location, targetSite, StringComparison.OrdinalIgnoreCase))
    {
      alert = "La source et la destination sont identiques."; return;
    }
    if (qty <= 0) { alert = "Quantit√© invalide."; return; }
    if (selected.Quantity <= 0) { alert = "La source n‚Äôa plus de stock."; return; }

    // Appel clair du service : (id, fromSite, toSite, qty)
    var ok = CellarSvc.Transfer(selected.Id, selected.Location!, targetSite!, qty);
    if (ok)
    {
      alertOk = true;
      alert = $"Transfert effectu√© : {qty} vers {targetSite}.";

      // Option : supprimer la source si stock atteint 0
      var gid = selected.Id;
      selected = CellarSvc.Get(gid);
      if (deleteWhenZero && (selected?.Quantity ?? 0) == 0)
      {
        CellarSvc.Delete(gid);
        selected = null;
        sourceId = null;
        alert += " (r√©f√©rence source supprim√©e)";
      }

      StateHasChanged();
    }
    else
    {
      alert = "Transfert impossible (v√©rifie la quantit√© et le site cible).";
    }
  }

  string FormatBottle(Bottle b)
    => $"{(b.Location ?? "?").ToUpperInvariant()} ¬∑ {b.Producer} ‚Äì {b.Name} {(b.Vintage>0?$"({b.Vintage})":"")} ¬∑ Stock {b.Quantity}";

  void Back() => Nav.NavigateTo("/cellar");
}
