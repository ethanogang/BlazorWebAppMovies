@page "/transfer"
@page "/transfer/{Id:guid}"

@using MaCaveServeur.Models
@using MaCaveServeur.Services

@inject CellarService CellarSvc
@inject AppState State
@inject NavigationManager Nav

<PageTitle>Transfert</PageTitle>

<div class="max-w-4xl mx-auto">

    <header class="glass-panel mb-6 p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white">üîÅ Transfert</h1>
                <p class="text-white/70">Choisis une bouteille source, un site cible et une quantit√©.</p>
            </div>
            <button class="btn-secondary" @onclick="Back">Retour</button>
        </div>
    </header>

    @if (!string.IsNullOrWhiteSpace(Alert))
    {
        <div class="glass-panel p-4 mb-6">
            <div class="text-white">@Alert</div>
        </div>
    }

    <div class="glass-panel p-6 space-y-5">
        <div>
            <label class="label">Bouteille source</label>
            <select class="select" @bind="SelectedId" @bind:after="OnSourceChanged">
                <option value="">‚Äî Choisir ‚Äî</option>
                @foreach (var b in SourceList)
                {
                    <option value="@b.Id.ToString()">@FormatBottle(b)</option>
                }
            </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="label">Site cible</label>
                <select class="select" @bind="TargetSiteCode">
                    <option value="">‚Äî Choisir ‚Äî</option>
                    @foreach (var s in State.AllSites.Where(s => s.Code != "ALL"))
                    {
                        <option value="@s.Code">@s.Label</option>
                    }
                </select>
            </div>

            <div>
                <label class="label">Quantit√©</label>
                <input class="input" type="number" min="1" @bind="Qty" />
                <div class="text-white/60 text-sm mt-1">
                    Dispo : <span class="text-white font-semibold">@((SelectedBottle?.Quantity) ?? 0)</span>
                </div>
            </div>
        </div>

        <div class="flex gap-3">
            <button class="btn-primary" @onclick="DoTransfer" disabled="@(!CanTransfer)">Transf√©rer</button>
            <button class="btn-secondary" @onclick="Back">Annuler</button>
        </div>
    </div>
</div>

@code {
    [Parameter] public Guid? Id { get; set; }

    private List<Bottle> All = new();
    private List<Bottle> SourceList = new();

    private string? SelectedId;
    private Bottle? SelectedBottle;

    private string? TargetSiteCode;
    private int Qty = 1;

    private string? Alert;

    protected override void OnInitialized()
    {
        All = CellarSvc.GetAllWines() ?? new List<Bottle>();

        SourceList = State.IsAll
            ? All.OrderBy(b => b.SiteCode).ThenBy(b => b.Producer).ThenBy(b => b.Name).ToList()
            : All.Where(b => string.Equals(b.SiteCode, State.CurrentSiteCode, StringComparison.OrdinalIgnoreCase))
                 .OrderBy(b => b.Producer).ThenBy(b => b.Name).ToList();

        if (Id.HasValue && Id.Value != Guid.Empty)
        {
            SelectedBottle = All.FirstOrDefault(b => b.Id == Id.Value);
            if (SelectedBottle != null)
            {
                SelectedId = SelectedBottle.Id.ToString();
                Qty = 1;
            }
        }
    }

    private void OnSourceChanged()
    {
        Alert = null;

        if (Guid.TryParse(SelectedId, out var id))
        {
            SelectedBottle = All.FirstOrDefault(b => b.Id == id);
            Qty = 1;
        }
        else
        {
            SelectedBottle = null;
        }
    }

    private bool CanTransfer =>
        SelectedBottle != null
        && !string.IsNullOrWhiteSpace(SelectedBottle.SiteCode)
        && !string.IsNullOrWhiteSpace(TargetSiteCode)
        && Qty > 0
        && SelectedBottle.Quantity >= Qty
        && !string.Equals(SelectedBottle.SiteCode, TargetSiteCode, StringComparison.OrdinalIgnoreCase);

    private void DoTransfer()
    {
        Alert = null;

        if (SelectedBottle == null) { Alert = "Choisis une bouteille source."; return; }
        if (string.IsNullOrWhiteSpace(TargetSiteCode)) { Alert = "Choisis un site cible."; return; }

        var ok = CellarSvc.Transfer(SelectedBottle.Id, SelectedBottle.SiteCode ?? "", TargetSiteCode!, Qty);
        if (!ok)
        {
            Alert = "Transfert impossible (stock insuffisant ou sites invalides).";
            return;
        }

        Nav.NavigateTo("/cellar");
    }

    private void Back() => Nav.NavigateTo("/cellar");

    private static string FormatBottle(Bottle b)
        => $"{(b.SiteCode ?? "?")} ¬∑ {(b.Producer ?? "").Trim()} ¬∑ {(b.Name ?? "").Trim()} {(b.Vintage > 0 ? $"({b.Vintage})" : "")} ¬∑ Stock {b.Quantity}";
}
