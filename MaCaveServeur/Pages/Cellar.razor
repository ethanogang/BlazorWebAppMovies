@page "/wines"
@inject CellarService CellarService
@inject NavigationManager Navigation

<PageTitle>Mes Vins - Ma Cave</PageTitle>

<div class="min-h-screen bg-gray-50 p-4 md:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">
        
        <!-- En-t√™te de page -->
        <div class="mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4">
                <div>
                    <h1 class="section-title text-4xl mb-2">üç∑ Ma Collection</h1>
                    <p class="text-gray-600">
                        @FilteredWines.Count() bouteille@(FilteredWines.Count() > 1 ? "s" : "") 
                        ‚Ä¢ @FilteredWines.Sum(w => w.Quantity) unit√©@(FilteredWines.Sum(w => w.Quantity) > 1 ? "s" : "") en stock
                    </p>
                </div>
                <div class="flex gap-3">
                    <button class="btn-primary" @onclick="NavigateToAdd">
                        ‚ûï Ajouter un vin
                    </button>
                    <button class="btn-secondary" @onclick="ExportToCsv">
                        üì• Exporter
                    </button>
                </div>
            </div>

            <!-- Barre de recherche et filtres -->
            <div class="main-panel">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    
                    <!-- Recherche -->
                    <div class="md:col-span-2">
                        <input 
                            type="text" 
                            class="input-field" 
                            placeholder="üîç Rechercher un vin, r√©gion, mill√©sime..."
                            @bind="SearchQuery"
                            @bind:event="oninput"
                        />
                    </div>

                    <!-- Filtre r√©gion -->
                    <div>
                        <select class="select-field" @bind="SelectedRegion">
                            <option value="">Toutes les r√©gions</option>
                            @foreach (var region in AllRegions)
                            {
                                <option value="@region">@region</option>
                            }
                        </select>
                    </div>

                    <!-- Filtre type -->
                    <div>
                        <select class="select-field" @bind="SelectedType">
                            <option value="">Tous les types</option>
                            <option value="Rouge">üç∑ Rouge</option>
                            <option value="Blanc">ü•Ç Blanc</option>
                            <option value="Ros√©">üå∏ Ros√©</option>
                            <option value="Champagne">üçæ Champagne</option>
                        </select>
                    </div>
                </div>

                <!-- Filtres actifs -->
                @if (!string.IsNullOrEmpty(SearchQuery) || !string.IsNullOrEmpty(SelectedRegion) || !string.IsNullOrEmpty(SelectedType))
                {
                    <div class="mt-4 flex items-center gap-2 flex-wrap">
                        <span class="text-sm text-gray-600">Filtres actifs:</span>
                        
                        @if (!string.IsNullOrEmpty(SearchQuery))
                        {
                            <span class="badge badge-accent flex items-center gap-2">
                                "@SearchQuery"
                                <button @onclick="() => SearchQuery = string.Empty">‚úï</button>
                            </span>
                        }
                        
                        @if (!string.IsNullOrEmpty(SelectedRegion))
                        {
                            <span class="badge badge-accent flex items-center gap-2">
                                @SelectedRegion
                                <button @onclick="() => SelectedRegion = string.Empty">‚úï</button>
                            </span>
                        }
                        
                        @if (!string.IsNullOrEmpty(SelectedType))
                        {
                            <span class="badge badge-accent flex items-center gap-2">
                                @SelectedType
                                <button @onclick="() => SelectedType = string.Empty">‚úï</button>
                            </span>
                        }

                        <button class="text-sm text-accent hover:text-accent-deep font-semibold" @onclick="ClearFilters">
                            Effacer tout
                        </button>
                    </div>
                }
            </div>
        </div>

        <!-- Toggle Vue -->
        <div class="mb-6 flex items-center gap-4">
            <span class="text-sm font-semibold text-gray-600">Vue:</span>
            <div class="inline-flex rounded-lg border-2 border-gray-200 p-1 bg-white">
                <button 
                    class="@(ViewMode == "grid" ? "bg-accent text-white" : "text-gray-600") px-4 py-2 rounded-lg transition-all"
                    @onclick="() => ViewMode = \"grid\"">
                    ‚äû Grille
                </button>
                <button 
                    class="@(ViewMode == "list" ? "bg-accent text-white" : "text-gray-600") px-4 py-2 rounded-lg transition-all"
                    @onclick="() => ViewMode = \"list\"">
                    ‚ò∞ Liste
                </button>
            </div>
        </div>

        <!-- Contenu principal selon la vue -->
        @if (ViewMode == "grid")
        {
            <!-- Vue en grille -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                @foreach (var wine in FilteredWines)
                {
                    <div class="wine-card p-6 hover-lift">
                        <!-- Image de la bouteille -->
                        <div class="w-full h-48 bg-gradient-gold rounded-xl flex items-center justify-center text-6xl mb-4">
                            @GetWineIcon(wine.Type)
                        </div>

                        <!-- Infos principales -->
                        <div class="mb-4">
                            <div class="flex items-start justify-between mb-2">
                                <h3 class="text-xl font-bold text-slate-dark line-clamp-2 flex-1">
                                    @wine.Name
                                </h3>
                                @if (wine.Quantity <= 3)
                                {
                                    <span class="badge badge-warning flex-shrink-0 ml-2">‚ö†Ô∏è Stock bas</span>
                                }
                                else
                                {
                                    <span class="badge badge-success flex-shrink-0 ml-2">‚úì @wine.Quantity</span>
                                }
                            </div>

                            <div class="space-y-2 text-sm text-gray-600">
                                <p class="flex items-center gap-2">
                                    <span>üìç</span>
                                    <span class="font-semibold">@wine.Region</span>
                                </p>
                                <p class="flex items-center gap-2">
                                    <span>üìÖ</span>
                                    <span>Mill√©sime @wine.Year</span>
                                </p>
                                <p class="flex items-center gap-2">
                                    <span>üç∑</span>
                                    <span>@wine.Type</span>
                                </p>
                            </div>
                        </div>

                        <div class="divider"></div>

                        <!-- Prix et actions -->
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500">Prix unitaire</p>
                                <p class="text-2xl font-bold text-gradient-gold">
                                    @wine.Price.ToString("C")
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn-ghost" @onclick="() => EditWine(wine.Id)" title="Modifier">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn-ghost text-red-500 hover:bg-red-50" @onclick="() => ConfirmDelete(wine.Id)" title="Supprimer">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <!-- Vue en liste -->
            <div class="main-panel">
                <div class="overflow-x-auto">
                    <table class="elegant-table">
                        <thead>
                            <tr>
                                <th>Vin</th>
                                <th>R√©gion</th>
                                <th>Mill√©sime</th>
                                <th>Type</th>
                                <th>Stock</th>
                                <th>Prix</th>
                                <th>Valeur totale</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var wine in FilteredWines)
                            {
                                <tr>
                                    <td>
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">@GetWineIcon(wine.Type)</span>
                                            <div>
                                                <p class="font-bold text-slate-dark">@wine.Name</p>
                                                @if (!string.IsNullOrEmpty(wine.Producer))
                                                {
                                                    <p class="text-sm text-gray-500">@wine.Producer</p>
                                                }
                                            </div>
                                        </div>
                                    </td>
                                    <td class="font-semibold">@wine.Region</td>
                                    <td>@wine.Year</td>
                                    <td>
                                        <span class="badge badge-info">@wine.Type</span>
                                    </td>
                                    <td>
                                        @if (wine.Quantity <= 3)
                                        {
                                            <span class="badge badge-warning">‚ö†Ô∏è @wine.Quantity</span>
                                        }
                                        else
                                        {
                                            <span class="badge badge-success">@wine.Quantity</span>
                                        }
                                    </td>
                                    <td class="text-gold font-bold">@wine.Price.ToString("C")</td>
                                    <td class="text-gradient-gold font-bold">@((wine.Price * wine.Quantity).ToString("C"))</td>
                                    <td>
                                        <div class="flex gap-2">
                                            <button class="btn-ghost text-sm" @onclick="() => EditWine(wine.Id)">
                                                ‚úèÔ∏è Modifier
                                            </button>
                                            <button class="btn-ghost text-sm text-red-500 hover:bg-red-50" @onclick="() => ConfirmDelete(wine.Id)">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        <!-- Message si aucun r√©sultat -->
        @if (!FilteredWines.Any())
        {
            <div class="main-panel text-center py-16">
                <div class="text-6xl mb-4">üîç</div>
                <h3 class="text-2xl font-bold text-slate-dark mb-2">Aucun vin trouv√©</h3>
                <p class="text-gray-600 mb-6">
                    Essayez de modifier vos crit√®res de recherche
                </p>
                <button class="btn-secondary" @onclick="ClearFilters">
                    R√©initialiser les filtres
                </button>
            </div>
        }

    </div>
</div>

@code {
    // Propri√©t√©s de filtrage
    private string SearchQuery { get; set; } = string.Empty;
    private string SelectedRegion { get; set; } = string.Empty;
    private string SelectedType { get; set; } = string.Empty;
    private string ViewMode { get; set; } = "grid"; // "grid" ou "list"

    // Donn√©es
    private List<Wine> AllWines => CellarService.GetAllWines();
    private List<string> AllRegions => AllWines.Select(w => w.Region).Distinct().OrderBy(r => r).ToList();

    // Vins filtr√©s
    private IEnumerable<Wine> FilteredWines
    {
        get
        {
            var wines = AllWines.AsEnumerable();

            if (!string.IsNullOrEmpty(SearchQuery))
            {
                wines = wines.Where(w =>
                    w.Name.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ||
                    w.Region.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ||
                    w.Year.ToString().Contains(SearchQuery) ||
                    (w.Producer?.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ?? false)
                );
            }

            if (!string.IsNullOrEmpty(SelectedRegion))
            {
                wines = wines.Where(w => w.Region == SelectedRegion);
            }

            if (!string.IsNullOrEmpty(SelectedType))
            {
                wines = wines.Where(w => w.Type == SelectedType);
            }

            return wines.OrderBy(w => w.Name);
        }
    }

    // M√©thodes
    private string GetWineIcon(string type)
    {
        return type switch
        {
            "Rouge" => "üç∑",
            "Blanc" => "ü•Ç",
            "Ros√©" => "üå∏",
            "Champagne" => "üçæ",
            _ => "üç∑"
        };
    }

    private void ClearFilters()
    {
        SearchQuery = string.Empty;
        SelectedRegion = string.Empty;
        SelectedType = string.Empty;
    }

    private void NavigateToAdd()
    {
        Navigation.NavigateTo("/wines/add");
    }

    private void EditWine(Guid id)
    {
        Navigation.NavigateTo($"/wines/edit/{id}");
    }

    private void ConfirmDelete(Guid id)
    {
        // TODO: Impl√©menter une vraie modal de confirmation
        // Pour l'instant, suppression directe
        CellarService.DeleteWine(id);
        StateHasChanged();
    }

    private void ExportToCsv()
    {
        // TODO: Impl√©menter l'export CSV
    }

    // Classe Wine (adaptez selon votre mod√®le r√©el)
    public class Wine
    {
        public Guid Id { get; set; }
        public string Name { get; set; }
        public string Region { get; set; }
        public int Year { get; set; }
        public string Type { get; set; }
        public decimal Price { get; set; }
        public int Quantity { get; set; }
        public string Producer { get; set; }
    }
}