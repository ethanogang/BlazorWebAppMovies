@page "/cellar"

@using MaCaveServeur.Models
@using MaCaveServeur.Services

@inject CellarService CellarSvc
@inject AppState State
@inject NavigationManager Nav

<PageTitle>Ma Cave</PageTitle>

<div class="max-w-7xl mx-auto">

    <header class="glass-panel mb-6 p-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white">üì¶ Ma Cave</h1>
                <p class="text-white/70">
                    Site : <span class="font-semibold">@State.CurrentSiteName</span>
                </p>
            </div>

            <div class="flex flex-wrap gap-3">
                <button class="btn-primary" @onclick="NewBottle">+ Ajouter</button>
                <button class="btn-secondary" @onclick="GoDashboard">Dashboard</button>
                <button class="btn-secondary" @onclick="GoTransfer">Transf√©rer</button>
            </div>
        </div>
    </header>

    <div class="glass-panel p-5 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="label">Filtrer par site</label>
                <select class="select" @bind="SelectedSiteCode" @bind:after="OnSiteChanged">
                    @foreach (var s in State.AllSites)
                    {
                        <option value="@s.Code">@s.Label</option>
                    }
                </select>
            </div>

            <div class="md:col-span-2">
                <label class="label">Recherche (producteur / nom / r√©gion)</label>
                <input class="input" placeholder="Ex: Bordeaux, Domaine..., etc."
                       @bind="Search" @bind:event="oninput" />
            </div>
        </div>

        <div class="mt-4 flex gap-3">
            <button class="btn-secondary" @onclick="Reload">Rafra√Æchir</button>
        </div>
    </div>

    @if (!string.IsNullOrWhiteSpace(Alert))
    {
        <div class="glass-panel p-4 mb-6">
            <div class="text-white">@Alert</div>
        </div>
    }

    <div class="glass-panel p-5">
        <div class="flex items-center justify-between mb-3">
            <div class="text-white/70 text-sm">
                Lignes : <span class="text-white font-semibold">@Filtered.Count</span>
                ‚Äî Stock total : <span class="text-white font-semibold">@Filtered.Sum(b => b.Quantity)</span>
            </div>
        </div>

        @if (Filtered.Count == 0)
        {
            <div class="text-white/70">Aucune bouteille.</div>
        }
        else
        {
            <div class="overflow-auto">
                <table class="table">
                    <thead class="thead">
                        <tr>
                            <th>Site</th>
                            <th>Producteur</th>
                            <th>Nom</th>
                            <th>R√©gion</th>
                            <th>Mill√©sime</th>
                            <th class="text-right">Stock</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var b in Filtered)
                        {
                            <tr class="trow">
                                <td>@(b.SiteCode ?? "-")</td>
                                <td>@((b.Producer ?? "").Trim())</td>
                                <td>@((b.Name ?? "").Trim())</td>
                                <td>@((b.Region ?? "").Trim())</td>
                                <td>@(b.Vintage > 0 ? b.Vintage : "")</td>
                                <td class="text-right font-semibold">@b.Quantity</td>
                                <td class="text-right">
                                    <div class="flex justify-end gap-2">
                                        <button class="btn-secondary" @onclick="() => EditBottle(b.Id)">√âditer</button>
                                        <button class="btn-secondary" @onclick="() => TransferBottle(b.Id)">Transf√©rer</button>
                                        <button class="btn-danger" @onclick="() => DeleteBottle(b.Id)">Supprimer</button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

</div>

@code {
    private List<Bottle> All = new();
    private List<Bottle> Filtered = new();

    private string SelectedSiteCode = "ALL";
    private string Search = "";
    private string? Alert;

    protected override void OnInitialized()
    {
        SelectedSiteCode = State.CurrentSiteCode;
        Reload();
    }

    private void OnSiteChanged()
    {
        State.SetSite(SelectedSiteCode);
        ApplyFilters();
    }

    private void Reload()
    {
        Alert = null;
        All = CellarSvc.GetAllWines() ?? new List<Bottle>();
        ApplyFilters();
    }

    private void ApplyFilters()
    {
        IEnumerable<Bottle> q = All;

        if (!string.Equals(SelectedSiteCode, "ALL", StringComparison.OrdinalIgnoreCase))
        {
            q = q.Where(b => string.Equals((b.SiteCode ?? "").Trim(), SelectedSiteCode, StringComparison.OrdinalIgnoreCase));
        }

        var s = (Search ?? "").Trim();
        if (!string.IsNullOrWhiteSpace(s))
        {
            q = q.Where(b =>
                ((b.Producer ?? "").Contains(s, StringComparison.OrdinalIgnoreCase)) ||
                ((b.Name ?? "").Contains(s, StringComparison.OrdinalIgnoreCase)) ||
                ((b.Region ?? "").Contains(s, StringComparison.OrdinalIgnoreCase)));
        }

        Filtered = q
            .OrderBy(b => b.SiteCode)
            .ThenBy(b => b.Producer)
            .ThenBy(b => b.Name)
            .ToList();
    }

    private void NewBottle() => Nav.NavigateTo("/cellar/new");
    private void EditBottle(Guid id) => Nav.NavigateTo($"/cellar/new/{id}");
    private void TransferBottle(Guid id) => Nav.NavigateTo($"/transfer/{id}");
    private void GoTransfer() => Nav.NavigateTo("/transfer");
    private void GoDashboard() => Nav.NavigateTo("/dashboard");

    private void DeleteBottle(Guid id)
    {
        try
        {
            CellarSvc.DeleteWine(id);
            Alert = "Bouteille supprim√©e.";
            Reload();
        }
        catch (Exception ex)
        {
            Alert = $"Erreur suppression : {ex.Message}";
        }
    }
}
