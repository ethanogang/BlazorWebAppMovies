@page "/cellar/edit/{Id:guid}"
@using MaCaveServeur.Models
@inject MaCaveServeur.Services.CellarService CellarSvc
@inject MaCaveServeur.Services.SupplierService SupplierSvc
@inject NavigationManager Nav
@inject MaCaveServeur.Services.AppState State

<div class="page-header">
    <div class="page-eyebrow">Bouteille</div>
    <div class="page-title">Editer une bouteille</div>
    <div class="page-sub">Modifie les informations de la bouteille.</div>
</div>

<div class="flex gap-3 mt-4">
    <button class="btn-secondary" @onclick="Back">Retour</button>
</div>

@if (loading)
{
    <div class="panel mt-6">Chargement...</div>
}
else if (bottle is null)
{
    <div class="panel mt-6">Bouteille introuvable.</div>
}
else
{
    <EditForm Model="bottle" OnValidSubmit="Save">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="panel mt-6 space-y-5">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Nom (cuvee)</label>
                    <InputText class="input" @bind-Value="bottle.Name" />
                </div>
                <div>
                    <label class="label">Producteur</label>
                    <InputText class="input" @bind-Value="bottle.Producer" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Appellation</label>
                    <InputText class="input" @bind-Value="bottle.Appellation" />
                </div>
                <div>
                    <label class="label">Couleur</label>
                    <InputText class="input" @bind-Value="bottle.Color" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Code produit</label>
                    <InputText class="input" @bind-Value="bottle.ProductReferenceCode" />
                </div>
                <div>
                    <label class="label">Designation</label>
                    <InputText class="input" @bind-Value="bottle.Designation" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Millesime</label>
                    <InputNumber class="input" @bind-Value="bottle.Vintage" />
                </div>
                <div>
                    <label class="label">Cepages</label>
                    <InputText class="input" @bind-Value="bottle.Grapes" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Pays</label>
                    <InputText class="input" @bind-Value="bottle.Country" />
                </div>
                <div>
                    <label class="label">Region</label>
                    <InputText class="input" @bind-Value="bottle.Region" />
                </div>
            </div>

            <div>
                <label class="label">Fournisseur (depuis la base)</label>
                <select class="select" @bind="bottle.Supplier">
                    <option value="">- Choisir -</option>
                    @foreach (var s in suppliers)
                    {
                        <option value="@s.Name">@s.Name</option>
                    }
                </select>
                <div class="text-white/60 text-sm mt-2">
                    La liste provient de <code>/suppliers</code>. La valeur enregistree est le nom du fournisseur.
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Quantite</label>
                    <InputNumber class="input" @bind-Value="bottle.Quantity" />
                </div>
                <div>
                    <label class="label">Seuil alerte</label>
                    <InputNumber class="input" @bind-Value="bottle.LowStockThreshold" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Prix achat (EUR)</label>
                    <InputNumber class="input" @bind-Value="bottle.PurchasePrice" />
                </div>
                <div>
                    <label class="label">Prix vente (EUR)</label>
                    <InputNumber class="input" @bind-Value="bottle.SalePrice" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">Prix verre (EUR)</label>
                    <InputNumber class="input" @bind-Value="bottle.GlassSellPrice" />
                </div>
                <div>
                    <label class="label">Contenance (ml)</label>
                    <InputNumber class="input" @bind-Value="bottle.Capacity" />
                </div>
            </div>

            <div>
                <label class="label">Etablissement / Site</label>
                <InputSelect class="select" @bind-Value="bottle.SiteCode">
                    @foreach (var s in State.AllSites.Where(s => s.Code != "ALL"))
                    {
                        <option value="@s.Code">@s.Label</option>
                    }
                </InputSelect>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="label">ID externe</label>
                    <InputText class="input" @bind-Value="bottle.ExternalId" />
                </div>
                <div>
                    <label class="label">ID verre</label>
                    <InputText class="input" @bind-Value="bottle.GlassExternalId" />
                </div>
            </div>

            <div>
                <label class="label">Notes</label>
                <InputTextArea class="textarea" rows="3" @bind-Value="bottle.Notes" />
            </div>

            <div class="flex gap-3 pt-2">
                <button class="btn-primary" type="submit">Enregistrer</button>
                <button class="btn-secondary" type="button" @onclick="Back">Annuler</button>
            </div>
        </div>
    </EditForm>
}

@code {
    [Parameter] public Guid Id { get; set; }

    bool loading = true;
    Bottle? bottle;
    List<MaCaveServeur.Models.Supplier> suppliers = new();

    protected override async Task OnInitializedAsync()
    {
        bottle = CellarSvc.Get(Id);
        suppliers = await SupplierSvc.AllAsync();
        loading = false;
    }

    async Task Save()
    {
        if (bottle is null) return;
        CellarSvc.Upsert(bottle);
        await Task.CompletedTask;
        Back();
    }

    void Back() => Nav.NavigateTo("/cellar");
}
