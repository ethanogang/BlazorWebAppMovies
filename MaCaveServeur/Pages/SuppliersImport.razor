@page "/suppliers/import"
@inject MaCaveServeur.Services.SupplierService SupplierSvc

<div class="page-header">
  <div class="page-eyebrow">Referentiel</div>
  <div class="page-title">Importer des fournisseurs</div>
  <div class="page-sub">Charge un fichier Excel pour alimenter le referentiel.</div>
</div>

<div class="panel mt-6 space-y-4">
  <div class="text-white/70 text-sm">
    Le fichier doit contenir un onglet avec des en-tetes (insensible a la casse) :
    <code>Nom/Fournisseur/Supplier</code>,
    <code>Contact/Commercial</code>,
    <code>Email</code>,
    <code>Phone/Telephone</code>,
    <code>Notes</code>.
  </div>

  <InputFile OnChange="OnFile" accept=".xlsx" />

  @if (!string.IsNullOrEmpty(msg))
  {
    <div class="text-white/80 text-sm">@msg</div>
  }
</div>

@code {
  string msg = "";

  async Task OnFile(InputFileChangeEventArgs e)
  {
    var file = e.File;
    if (file is null)
    {
      msg = "Aucun fichier.";
      return;
    }

    try
    {
      using var ms = new MemoryStream();
      await file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024).CopyToAsync(ms);
      ms.Position = 0;

      var (inserted, updated) = await SupplierSvc.ImportExcelAsync(ms);
      msg = $"Import termine : {inserted} ajout(s), {updated} mise(s) a jour.";
    }
    catch (Exception ex)
    {
      msg = $"Erreur import : {ex.Message}";
    }
  }
}
