@page "/dashboard"
@using MaCaveServeur.Models
@using MaCaveServeur.Services
@inject CellarService CellarService
@inject OrderService OrderService

<PageTitle>Dashboard - Ma Cave</PageTitle>

<!-- Conteneur principal avec fond d√©grad√© -->
<div class="min-h-screen bg-gradient-dark p-4 md:p-6 lg:p-8">
    <div class="max-w-7xl mx-auto">
        
        <!-- En-t√™te avec effet de verre -->
        <header class="glass-panel mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="text-4xl md:text-5xl font-bold text-white mb-2">
                        üç∑ Ma Cave
                    </h1>
                    <p class="text-gray-300">
                        G√©rez votre collection avec √©l√©gance
                    </p>
                </div>
                <div class="flex gap-3">
                    <button class="btn-gold" @onclick="NavigateToAddWine">
                        + Ajouter une bouteille
                    </button>
                    <button class="btn-secondary">
                        üìä Rapports
                    </button>
                </div>
            </div>
        </header>

        <!-- Cartes de statistiques -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            
            <!-- Total bouteilles -->
            <div class="stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="stat-label">Bouteilles totales</p>
                        <p class="stat-value">@TotalBottles</p>
                        <p class="text-xs text-gray-500 mt-1">
                            <span class="text-green-600">‚Üó +12</span> ce mois
                        </p>
                    </div>
                    <div class="stat-icon">
                        üçæ
                    </div>
                </div>
            </div>

            <!-- Valeur totale -->
            <div class="stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="stat-label">Valeur totale</p>
                        <p class="text-3xl font-bold text-gradient-gold">@TotalValue.ToString("C")</p>
                        <p class="text-xs text-gray-500 mt-1">
                            Estimation actuelle
                        </p>
                    </div>
                    <div class="stat-icon bg-gold/10">
                        üí∞
                    </div>
                </div>
            </div>

            <!-- R√©gions -->
            <div class="stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="stat-label">R√©gions</p>
                        <p class="stat-value">@TotalRegions</p>
                        <p class="text-xs text-gray-500 mt-1">
                            France, Italie, Espagne...
                        </p>
                    </div>
                    <div class="stat-icon bg-wine-red/10">
                        üåç
                    </div>
                </div>
            </div>

            <!-- Commandes en cours -->
            <div class="stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="stat-label">Commandes</p>
                        <p class="stat-value">@PendingOrders</p>
                        <p class="text-xs text-gray-500 mt-1">
                            En attente de livraison
                        </p>
                    </div>
                    <div class="stat-icon bg-blue-500/10">
                        üì¶
                    </div>
                </div>
            </div>
        </div>

        <!-- Grille principale : Vins r√©cents + Graphiques -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            
            <!-- Vins r√©cemment ajout√©s (2/3) -->
            <div class="lg:col-span-2">
                <div class="main-panel">
                    <div class="section-header">
                        <h2 class="section-title">Derniers ajouts</h2>
                        <a href="/cellar" class="text-accent hover:text-accent-deep font-semibold">
                            Voir tout ‚Üí
                        </a>
                    </div>

                    <div class="space-y-4">
                        @foreach (var wine in RecentWines.Take(5))
                        {
                            <div class="wine-card p-4 hover-lift">
                                <div class="flex items-center gap-4">
                                    <!-- Image/Ic√¥ne -->
                                    <div class="w-16 h-20 bg-gradient-gold rounded-lg flex items-center justify-center text-3xl flex-shrink-0">
                                        üç∑
                                    </div>
                                    
                                    <!-- Infos -->
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-start justify-between gap-2 mb-2">
                                            <h3 class="text-lg font-bold text-slate-dark truncate">
                                                @wine.Name
                                            </h3>
                                            <span class="badge badge-success flex-shrink-0">
                                                @wine.Quantity en stock
                                            </span>
                                        </div>
                                        
                                        <div class="flex flex-wrap gap-3 text-sm text-gray-600">
                                            <span>üìç @wine.Region</span>
                                            <span>üìÖ @wine.Year</span>
                                            <span class="text-gold font-bold">üí∂ @wine.PurchasePrice.ToString("C")</span>
                                        </div>
                                    </div>

                                    <!-- Actions -->
                                    <div class="flex flex-col gap-2 flex-shrink-0">
                                        <button class="btn-ghost text-sm" @onclick="() => ViewDetails(wine.Id)">
                                            üëÅÔ∏è Voir
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }

                        @if (!RecentWines.Any())
                        {
                            <div class="text-center py-12 text-gray-400">
                                <div class="text-6xl mb-4">üçæ</div>
                                <p class="text-lg">Aucun vin pour le moment</p>
                                <button class="btn-primary mt-4" @onclick="NavigateToAddWine">
                                    Ajouter votre premier vin
                                </button>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Sidebar : Alertes + Actions rapides (1/3) -->
            <div class="space-y-6">
                
                <!-- Alertes de stock -->
                <div class="main-panel">
                    <h3 class="text-xl font-bold text-slate-dark mb-4 flex items-center gap-2">
                        ‚ö†Ô∏è Alertes
                    </h3>
                    
                    @if (LowStockWines.Any())
                    {
                        <div class="space-y-3">
                            @foreach (var wine in LowStockWines.Take(3))
                            {
                                <div class="alert-warning">
                                    <p class="font-semibold">@wine.Name</p>
                                    <p class="text-sm">Stock faible: @wine.Quantity bouteilles</p>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert-success">
                            <p class="font-semibold">‚úì Tous les stocks sont OK</p>
                        </div>
                    }
                </div>

                <!-- Actions rapides -->
                <div class="main-panel">
                    <h3 class="text-xl font-bold text-slate-dark mb-4">
                        üöÄ Actions rapides
                    </h3>
                    
                    <div class="space-y-2">
                        <button class="w-full btn-secondary justify-start" @onclick="NavigateToAddWine">
                            ‚ûï Ajouter un vin
                        </button>
                        <button class="w-full btn-secondary justify-start" @onclick="NavigateToOrders">
                            üì¶ Nouvelle commande
                        </button>
                        <button class="w-full btn-secondary justify-start" @onclick="NavigateToSuppliers">
                            üè¢ G√©rer fournisseurs
                        </button>
                        <button class="w-full btn-secondary justify-start">
                            üìä Exporter donn√©es
                        </button>
                    </div>
                </div>

                <!-- Top r√©gions -->
                <div class="main-panel">
                    <h3 class="text-xl font-bold text-slate-dark mb-4">
                        üèÜ Top r√©gions
                    </h3>
                    
                    <div class="space-y-3">
                        @foreach (var region in TopRegions.Take(5))
                        {
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">@region.Name</span>
                                <span class="badge badge-accent">@region.Count</span>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Section commandes r√©centes -->
        <div class="main-panel">
            <div class="section-header">
                <h2 class="section-title">Commandes r√©centes</h2>
                <a href="/orders" class="text-accent hover:text-accent-deep font-semibold">
                    Voir tout ‚Üí
                </a>
            </div>

            <div class="overflow-x-auto">
                <table class="elegant-table">
                    <thead>
                        <tr>
                            <th>N¬∞ Commande</th>
                            <th>Date</th>
                            <th>Fournisseur</th>
                            <th>Articles</th>
                            <th>Total</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var order in RecentOrders.Take(5))
                        {
                            <tr>
                                <td class="font-mono text-sm">@order.Id.ToString().Substring(0, 8)</td>
                                <td>@order.CreationDate.ToString("dd/MM/yyyy")</td>
                                <td class="font-semibold">@order.SupplierName</td>
                                <td>@order.Lines.Count articles</td>
                                <td class="text-gold font-bold">@order.TotalAmount.ToString("C")</td>
                                <td>
                                    @if (order.IsDelivered)
                                    {
                                        <span class="badge badge-success">Livr√©e</span>
                                    }
                                    else
                                    {
                                        <span class="badge badge-warning">En cours</span>
                                    }
                                </td>
                                <td>
                                    <button class="btn-ghost text-sm" @onclick="() => ViewOrder(order.Id)">
                                        üëÅÔ∏è D√©tails
                                    </button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

@code {
    // Propri√©t√©s calcul√©es
    private int TotalBottles => CellarService.GetAllWines().Sum(w => w.Quantity);
    private decimal TotalValue => CellarService.GetAllWines().Sum(w => w.PurchasePrice * w.Quantity);
    private int TotalRegions => CellarService.GetAllWines().Select(w => w.Region).Distinct().Count();
    private int PendingOrders => OrderService.GetAllOrders().Count(o => !o.IsDelivered);
    
    private List<WineBottle> RecentWines => CellarService.GetAllWines().OrderByDescending(w => w.Id).ToList();
    private List<WineBottle> LowStockWines => CellarService.GetAllWines().Where(w => w.Quantity <= 3).ToList();
    private List<Order> RecentOrders => OrderService.GetAllOrders().OrderByDescending(o => o.CreationDate).ToList();
    
    private List<(string Name, int Count)> TopRegions => 
        CellarService.GetAllWines()
            .GroupBy(w => w.Region)
            .Select(g => (Name: g.Key, Count: g.Sum(w => w.Quantity)))
            .OrderByDescending(x => x.Count)
            .ToList();

    // M√©thodes de navigation
    private void NavigateToAddWine() 
    { 
        // TODO: Impl√©menter navigation
    }
    
    private void NavigateToOrders() 
    { 
        // TODO: Impl√©menter navigation
    }
    
    private void NavigateToSuppliers() 
    { 
        // TODO: Impl√©menter navigation
    }
    
    private void ViewDetails(Guid id) 
    { 
        // TODO: Impl√©menter navigation
    }
    
    private void ViewOrder(Guid id) 
    { 
        // TODO: Impl√©menter navigation
    }
}