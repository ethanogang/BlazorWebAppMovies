@page "/dashboard"

@using MaCaveServeur.Models
@using MaCaveServeur.Services

@inject CellarService CellarService
@inject AppState State
@inject NavigationManager Nav

<PageTitle>Dashboard</PageTitle>

<style>
.dashboard-container {
    max-width: 1200px;
    margin: 0 auto;
}

.panel {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 18px;
    padding: 24px;
    margin-bottom: 24px;
}

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
}

.kpi {
    background: rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 20px;
}

.kpi-title {
    color: rgba(255,255,255,0.7);
    font-size: 14px;
}

.kpi-value {
    font-size: 32px;
    font-weight: bold;
    margin-top: 6px;
}

.actions {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
}

.actions button {
    padding: 10px 16px;
    border-radius: 12px;
    border: none;
    font-weight: 600;
    cursor: pointer;
}

.btn-primary {
    background: white;
    color: black;
}

.btn-secondary {
    background: rgba(255,255,255,0.15);
    color: white;
}
</style>

<div class="dashboard-container">

    <!-- HEADER -->
    <div class="panel">
        <h1 style="font-size:32px;font-weight:bold">ðŸ§­ Dashboard</h1>
        <p style="opacity:0.7">
            Vue globale â€” <strong>@State.CurrentSiteName</strong>
        </p>
    </div>

    <!-- KPI -->
    <div class="kpi-grid">
        <div class="kpi">
            <div class="kpi-title">RÃ©fÃ©rences</div>
            <div class="kpi-value">@TotalReferences</div>
        </div>

        <div class="kpi">
            <div class="kpi-title">Bouteilles en stock</div>
            <div class="kpi-value">@TotalBottles</div>
        </div>

        <div class="kpi">
            <div class="kpi-title">Sous seuil</div>
            <div class="kpi-value">@LowStock</div>
        </div>

        <div class="kpi">
            <div class="kpi-title">Fournisseurs</div>
            <div class="kpi-value">@Suppliers</div>
        </div>
    </div>

    <!-- ACTIONS -->
    <div class="panel">
        <h2 style="font-size:20px;font-weight:bold;margin-bottom:16px">âš¡ Actions rapides</h2>

        <div class="actions">
            <button class="btn-primary" @onclick="GoAdd">âž• Ajouter une bouteille</button>
            <button class="btn-secondary" @onclick="GoCellar">ðŸ“¦ Voir la cave</button>
            <button class="btn-secondary" @onclick="GoOrders">ðŸ§¾ Commandes</button>
        </div>
    </div>

</div>

@code {
    private List<Bottle> _bottles = new();

    protected override void OnInitialized()
    {
        _bottles = CellarService.GetAllWines() ?? new();
    }

    private int TotalReferences => _bottles.Count;
    private int TotalBottles => _bottles.Sum(b => b.Quantity);
    private int LowStock => _bottles.Count(b => b.Quantity <= (b.LowStockThreshold > 0 ? b.LowStockThreshold : 3));
    private int Suppliers => _bottles
        .Select(b => b.Supplier)
        .Where(s => !string.IsNullOrWhiteSpace(s))
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .Count();

    private void GoAdd() => Nav.NavigateTo("/cellar/new");
    private void GoCellar() => Nav.NavigateTo("/cellar");
    private void GoOrders() => Nav.NavigateTo("/orders");
}
