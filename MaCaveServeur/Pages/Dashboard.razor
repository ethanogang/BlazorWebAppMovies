@page "/dashboard"

@using MaCaveServeur.Models
@using MaCaveServeur.Services

@inject CellarService CellarService
@inject AppState State

<PageTitle>Dashboard</PageTitle>

<div class="page-header">
    <div class="page-eyebrow">Dashboard</div>
    <div class="page-title">Dashboard</div>
    <div class="page-sub">Vue globale - <strong>@State.CurrentSiteName</strong></div>
</div>

<div class="kpi-grid mt-8">
    <div class="kpi-card">
        <div class="kpi-label">References</div>
        <div class="kpi-value">@TotalReferences</div>
        <div class="kpi-meta">cave active</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-label">Bouteilles</div>
        <div class="kpi-value">@TotalBottles</div>
        <div class="kpi-meta">en stock</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-label">Sous seuil</div>
        <div class="kpi-value">@LowStock</div>
        <div class="kpi-meta">a surveiller</div>
    </div>
    <div class="kpi-card">
        <div class="kpi-label">Fournisseurs</div>
        <div class="kpi-value">@Suppliers</div>
        <div class="kpi-meta">actifs</div>
    </div>
</div>

<div class="row mt-8">
    <div class="col">
        <div class="panel">
            <div class="card__head">
                <div class="card__title">Repartition par couleur</div>
            </div>
            <div class="card__body">
                @if (ByColor.Count == 0)
                {
                    <div class="chart-empty">Aucune donnee</div>
                }
                else
                {
                    <div class="table-wrap">
                        <table class="table">
                            <thead class="thead"><tr><th>Couleur</th><th>References</th></tr></thead>
                            <tbody>
                            @foreach (var kv in ByColor)
                            {
                                <tr class="trow"><td>@kv.Key</td><td>@kv.Value</td></tr>
                            }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
    <div class="col">
        <div class="panel">
            <div class="card__head">
                <div class="card__title">Top fournisseurs</div>
            </div>
            <div class="card__body">
                @if (BySupplier.Count == 0)
                {
                    <div class="chart-empty">Aucun fournisseur</div>
                }
                else
                {
                    <div class="table-wrap">
                        <table class="table">
                            <thead class="thead"><tr><th>Fournisseur</th><th>References</th></tr></thead>
                            <tbody>
                            @foreach (var kv in BySupplier)
                            {
                                <tr class="trow"><td>@kv.Key</td><td>@kv.Value</td></tr>
                            }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="panel mt-8">
    <div class="card__head">
        <div class="card__title">Sante cave</div>
    </div>
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-label">Surstock</div>
            <div class="kpi-value">@OverstockCount</div>
            <div class="kpi-meta">references</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Rotation lente</div>
            <div class="kpi-value">@SlowMovingCount</div>
            <div class="kpi-meta">references</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Immobilise</div>
            <div class="kpi-value">@ImmobilisedValue.ToString("0.00")</div>
            <div class="kpi-meta">EUR achat</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Sans fournisseur</div>
            <div class="kpi-value">@MissingSupplierCount</div>
            <div class="kpi-meta">references</div>
        </div>
    </div>

    <div class="row mt-6">
        <div class="col">
            <div class="card">
                <div class="card__head">
                    <div class="card__title">Top surstock</div>
                </div>
                <div class="card__body">
                    @if (OverstockItems.Count == 0)
                    {
                        <div class="chart-empty">Aucun surstock</div>
                    }
                    else
                    {
                        <div class="space-y-2">
                            @foreach (var b in OverstockItems)
                            {
                                <div class="flex items-center justify-between rounded-xl border border-white/10 bg-white/5 px-3 py-2">
                                    <div>
                                        <div class="font-semibold">@b.Name</div>
                                        <div class="text-sm">@b.Producer</div>
                                    </div>
                                    <div class="font-semibold">@b.Quantity</div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card">
                <div class="card__head">
                    <div class="card__title">Rotation lente (90j)</div>
                </div>
                <div class="card__body">
                    @if (SlowMovingItems.Count == 0)
                    {
                        <div class="chart-empty">Aucune reference</div>
                    }
                    else
                    {
                        <div class="space-y-2">
                            @foreach (var b in SlowMovingItems)
                            {
                                <div class="flex items-center justify-between rounded-xl border border-white/10 bg-white/5 px-3 py-2">
                                    <div>
                                        <div class="font-semibold">@b.Name</div>
                                        <div class="text-sm">@b.Producer</div>
                                    </div>
                                    <div class="text-sm">@((b.LastSeenUtc.HasValue) ? b.LastSeenUtc.Value.ToString("yyyy-MM-dd") : "Jamais")</div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="panel mt-8">
    <div class="card__head">
        <div class="card__title">Stock bas</div>
    </div>
    <div class="card__body">
        @if (LowStockItems.Count == 0)
        {
            <div class="chart-empty">Aucun stock bas</div>
        }
        else
        {
            <div class="space-y-2">
                @foreach (var b in LowStockItems)
                {
                    <div class="flex items-center justify-between rounded-xl border border-white/10 bg-white/5 px-3 py-2">
                        <div class="text-white">
                            <div class="font-semibold">@b.Name</div>
                            <div class="text-white/60 text-sm">@b.Producer</div>
                        </div>
                        <div class="text-white font-semibold">@b.Quantity</div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@code {
    private List<Bottle> _bottles = new();
    private Dictionary<string, int> ByColor = new();
    private Dictionary<string, int> BySupplier = new();
    private List<Bottle> LowStockItems = new();
    private List<Bottle> OverstockItems = new();
    private List<Bottle> SlowMovingItems = new();

    protected override void OnInitialized()
    {
        var all = CellarService.GetAllWines() ?? new();
        _bottles = State.IsAll
            ? all
            : all.Where(b => string.Equals(b.SiteCode, State.CurrentSiteCode, StringComparison.OrdinalIgnoreCase)).ToList();

        ByColor = _bottles
            .GroupBy(b => (b.Color ?? "INCONNU").ToUpperInvariant())
            .OrderByDescending(g => g.Count())
            .ToDictionary(g => g.Key, g => g.Count());

        BySupplier = _bottles
            .Where(b => !string.IsNullOrWhiteSpace(b.Supplier))
            .GroupBy(b => b.Supplier!.Trim())
            .OrderByDescending(g => g.Count())
            .Take(8)
            .ToDictionary(g => g.Key, g => g.Count());

        LowStockItems = _bottles
            .Where(IsLowStock)
            .OrderBy(b => b.Quantity)
            .Take(8)
            .ToList();

        OverstockItems = _bottles
            .Where(IsOverstock)
            .OrderByDescending(b => b.Quantity)
            .Take(8)
            .ToList();

        var now = DateTime.UtcNow;
        SlowMovingItems = _bottles
            .Where(b => IsSlowMoving(b, now))
            .OrderBy(b => b.LastSeenUtc ?? DateTime.MinValue)
            .Take(8)
            .ToList();
    }

    private int TotalReferences => _bottles.Count;
    private int TotalBottles => _bottles.Sum(b => b.Quantity);
    private int LowStock => _bottles.Count(IsLowStock);
    private int OverstockCount => _bottles.Count(IsOverstock);
    private int SlowMovingCount => _bottles.Count(b => IsSlowMoving(b, DateTime.UtcNow));
    private int MissingSupplierCount => _bottles.Count(b => string.IsNullOrWhiteSpace(b.Supplier));
    private decimal ImmobilisedValue => _bottles.Sum(b => b.PurchasePrice * b.Quantity);
    private int Suppliers => _bottles
        .Select(b => b.Supplier)
        .Where(s => !string.IsNullOrWhiteSpace(s))
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .Count();

    private static bool IsLowStock(Bottle b)
        => b.LowStockThreshold > 0 && b.Quantity <= b.LowStockThreshold;

    private static bool IsOverstock(Bottle b)
        => b.LowStockThreshold > 0 && b.Quantity >= b.LowStockThreshold * 2;

    private static bool IsSlowMoving(Bottle b, DateTime now)
        => b.Quantity > 0 && (!b.LastSeenUtc.HasValue || b.LastSeenUtc.Value < now.AddDays(-90));

}
